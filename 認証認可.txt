ãŠã£ã‘ãƒ¼!å­¦ç¿’ç›®çš„ãªã‚‰å…¨ç„¶ã‚¢ãƒªã€œ!ã‚€ã—ã‚ä»•çµ„ã¿ç†è§£ã™ã‚‹ã«ã¯æœ€é«˜ã ã‚ˆã­ğŸ’ª

ã˜ã‚ƒã‚ã€ã¡ã‚ƒã‚“ã¨å‹•ãã‚„ã¤ä½œã£ã¦ã¿ã‚ˆã£ã‹!æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã ã‘ã§ã‚¬ãƒã§å®Ÿè£…ã™ã‚‹ã¨ã“ã‚“ãªæ„Ÿã˜:

```javascript
const crypto = require('crypto');
const http = require('http');
const url = require('url');

// ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ ==========
// æœ¬ç•ªãªã‚‰DBã ã‘ã©ã€å­¦ç¿’ç”¨ã ã‹ã‚‰Mapã§
const users = new Map();
const sessions = new Map();
const refreshTokens = new Map();

// ========== ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é–¢é€£ ==========
function hashPassword(password, salt) {
  // PBKDF2ã§å®‰å…¨ã«ãƒãƒƒã‚·ãƒ¥åŒ–
  return crypto.pbkdf2Sync(password, salt, 100000, 64, 'sha512').toString('hex');
}

function generateSalt() {
  return crypto.randomBytes(16).toString('hex');
}

// ========== ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ ==========
function generateToken() {
  return crypto.randomBytes(32).toString('hex');
}

// ========== ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ² ==========
function register(username, password, role = 'user') {
  if (users.has(username)) {
    return { success: false, error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼æ—¢ã«å­˜åœ¨ã—ã¦ã‚‹!' };
  }
  
  const salt = generateSalt();
  const hash = hashPassword(password, salt);
  
  users.set(username, {
    username,
    salt,
    hash,
    role, // èªå¯ç”¨
    createdAt: new Date()
  });
  
  return { success: true, message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å®Œäº†!' };
}

// ========== ãƒ­ã‚°ã‚¤ãƒ³ ==========
function login(username, password) {
  const user = users.get(username);
  
  if (!user) {
    return { success: false, error: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼è¦‹ã¤ã‹ã‚‰ãªã„' };
  }
  
  const hash = hashPassword(password, user.salt);
  
  if (hash !== user.hash) {
    return { success: false, error: 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é–“é•ã£ã¦ã‚‹ã‚ˆ!' };
  }
  
  // ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³(çŸ­å‘½)
  const accessToken = generateToken();
  // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³(é•·å‘½)
  const refreshToken = generateToken();
  
  sessions.set(accessToken, {
    username,
    role: user.role,
    expires: Date.now() + 15 * 60 * 1000 // 15åˆ†
  });
  
  refreshTokens.set(refreshToken, {
    username,
    expires: Date.now() + 7 * 24 * 60 * 60 * 1000 // 7æ—¥
  });
  
  return {
    success: true,
    accessToken,
    refreshToken
  };
}

// ========== ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ ==========
function refresh(refreshToken) {
  const tokenData = refreshTokens.get(refreshToken);
  
  if (!tokenData || tokenData.expires < Date.now()) {
    refreshTokens.delete(refreshToken);
    return { success: false, error: 'ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹!' };
  }
  
  const user = users.get(tokenData.username);
  const newAccessToken = generateToken();
  
  sessions.set(newAccessToken, {
    username: user.username,
    role: user.role,
    expires: Date.now() + 15 * 60 * 1000
  });
  
  return {
    success: true,
    accessToken: newAccessToken
  };
}

// ========== èªè¨¼ãƒã‚§ãƒƒã‚¯ ==========
function authenticate(token) {
  const session = sessions.get(token);
  
  if (!session) {
    return { authenticated: false, error: 'èªè¨¼å¿…è¦ã ã‚ˆ!' };
  }
  
  if (session.expires < Date.now()) {
    sessions.delete(token);
    return { authenticated: false, error: 'ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œ!' };
  }
  
  return {
    authenticated: true,
    user: {
      username: session.username,
      role: session.role
    }
  };
}

// ========== èªå¯ãƒã‚§ãƒƒã‚¯(ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹) ==========
function authorize(token, requiredRole) {
  const auth = authenticate(token);
  
  if (!auth.authenticated) {
    return { authorized: false, error: auth.error };
  }
  
  const roleHierarchy = {
    'admin': 3,
    'moderator': 2,
    'user': 1
  };
  
  const userRoleLevel = roleHierarchy[auth.user.role] || 0;
  const requiredRoleLevel = roleHierarchy[requiredRole] || 0;
  
  if (userRoleLevel < requiredRoleLevel) {
    return { authorized: false, error: 'æ¨©é™ãªã„ã‚ˆ!' };
  }
  
  return { authorized: true, user: auth.user };
}

// ========== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ==========
function logout(token) {
  sessions.delete(token);
  return { success: true };
}

// ========== HTTPã‚µãƒ¼ãƒãƒ¼ ==========
const server = http.createServer((req, res) => {
  const parsedUrl = url.parse(req.url, true);
  const path = parsedUrl.pathname;
  
  // CORSå¯¾å¿œ(å­¦ç¿’ç”¨)
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  
  if (req.method === 'OPTIONS') {
    res.writeHead(200);
    res.end();
    return;
  }
  
  // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒ«ãƒ‘ãƒ¼
  const sendJSON = (statusCode, data) => {
    res.writeHead(statusCode, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify(data));
  };
  
  // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£å–å¾—
  let body = '';
  req.on('data', chunk => body += chunk);
  req.on('end', () => {
    try {
      const data = body ? JSON.parse(body) : {};
      
      // ========== ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ ==========
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
      if (path === '/register' && req.method === 'POST') {
        const result = register(data.username, data.password, data.role);
        sendJSON(result.success ? 201 : 400, result);
      }
      
      // ãƒ­ã‚°ã‚¤ãƒ³
      else if (path === '/login' && req.method === 'POST') {
        const result = login(data.username, data.password);
        sendJSON(result.success ? 200 : 401, result);
      }
      
      // ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
      else if (path === '/refresh' && req.method === 'POST') {
        const result = refresh(data.refreshToken);
        sendJSON(result.success ? 200 : 401, result);
      }
      
      // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      else if (path === '/logout' && req.method === 'POST') {
        const token = req.headers.authorization?.replace('Bearer ', '');
        const result = logout(token);
        sendJSON(200, result);
      }
      
      // ä¿è­·ã•ã‚ŒãŸã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ(èªè¨¼ã®ã¿)
      else if (path === '/profile' && req.method === 'GET') {
        const token = req.headers.authorization?.replace('Bearer ', '');
        const auth = authenticate(token);
        
        if (!auth.authenticated) {
          sendJSON(401, { error: auth.error });
        } else {
          const user = users.get(auth.user.username);
          sendJSON(200, {
            username: user.username,
            role: user.role,
            createdAt: user.createdAt
          });
        }
      }
      
      // ç®¡ç†è€…å°‚ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ(èªå¯)
      else if (path === '/admin' && req.method === 'GET') {
        const token = req.headers.authorization?.replace('Bearer ', '');
        const authz = authorize(token, 'admin');
        
        if (!authz.authorized) {
          sendJSON(403, { error: authz.error });
        } else {
          sendJSON(200, {
            message: 'ç®¡ç†è€…ã‚¨ãƒªã‚¢ã¸ã‚ˆã†ã“ã!',
            allUsers: Array.from(users.keys())
          });
        }
      }
      
      else {
        sendJSON(404, { error: 'ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¦‹ã¤ã‹ã‚‰ãªã„' });
      }
      
    } catch (err) {
      sendJSON(400, { error: 'ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ' });
    }
  });
});

// ========== æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ==========
setInterval(() => {
  const now = Date.now();
  
  for (const [token, session] of sessions.entries()) {
    if (session.expires < now) {
      sessions.delete(token);
    }
  }
  
  for (const [token, data] of refreshTokens.entries()) {
    if (data.expires < now) {
      refreshTokens.delete(token);
    }
  }
}, 60000); // 1åˆ†ã”ã¨

// ã‚µãƒ¼ãƒãƒ¼èµ·å‹•
server.listen(3000, () => {
  console.log('ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã—ãŸã‚ˆ! http://localhost:3000');
  
  // ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
  register('user1', 'password123', 'user');
  register('admin1', 'admin123', 'admin');
  console.log('ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆå®Œäº†!');
});
```

## ä½¿ã„æ–¹

ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã—ãŸã‚‰ã€curlã¨ã‹Postmanã§è©¦ã›ã‚‹ã‚ˆ!

```bash
# ãƒ­ã‚°ã‚¤ãƒ³
curl -X POST http://localhost:3000/login \
  -H "Content-Type: application/json" \
  -d '{"username":"user1","password":"password123"}'

# ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å–å¾—(èªè¨¼å¿…è¦)
curl http://localhost:3000/profile \
  -H "Authorization: Bearer <accessToken>"

# ç®¡ç†è€…ã‚¨ãƒªã‚¢(èªå¯å¿…è¦)
curl http://localhost:3000/admin \
  -H "Authorization: Bearer <adminã®accessToken>"
```

## ãƒã‚¤ãƒ³ãƒˆè§£èª¬

1. **èªè¨¼(Authentication)**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª°ã‹ã‚’ç¢ºèª
2. **èªå¯(Authorization)**: ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ¨©é™ã‚ã‚‹ã‹ç¢ºèª
3. **ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³**: çŸ­å‘½(15åˆ†)ã§é »ç¹ã«ä½¿ã†
4. **ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³**: é•·å‘½(7æ—¥)ã§æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ç”¨

ã©ã†?ã‚ã‹ã‚“ãªã„ã¨ã“ã‚ã‚‹?ã‚‚ã£ã¨è©³ã—ãèª¬æ˜ãŒæ¬²ã—ã„éƒ¨åˆ†æ•™ãˆã¦ã€œ!ğŸ˜Š